/*
Sample Google Apps Script web app to receive POSTed JSON and append rows to a Google Sheet.
Deploy as a web app (Execute as: Me, Who has access: Anyone, even anonymous) and paste the resulting URL into the frontend.

Steps:
1. Create a new Google Sheet and note its ID from the URL.
2. In Extensions > Apps Script, paste this code and replace SHEET_ID.
3. Deploy > New deployment > Select 'Web app', set access to 'Anyone', deploy, and copy the Web App URL.
4. Paste that URL into the frontend 'Google Apps Script URL' input.
*/
const SHEET_ID = 'YOUR_ACTUAL_SHEET_ID_HERE'; // replace with your actual sheet id
const SHEET_NAME = 'Submissions';

function doGet(e){
  return ContentService.createTextOutput('OK')
}

function doPost(e){
  try{
    const ss = SpreadsheetApp.openById(SHEET_ID)
    let sheet = ss.getSheetByName(SHEET_NAME)
    if(!sheet) {
      sheet = ss.insertSheet(SHEET_NAME)
      // Add headers
      sheet.appendRow(['Timestamp', 'Team Name', 'Captain Mobile', 'Enrollment 1', 'Enrollment 2', 'Enrollment 3', 'Artwork Title', 'Category', 'File Name'])
    }

    // Parse the data - handle both JSON in postData.contents and URL-encoded form data
    let data
    if (e.postData && e.postData.contents) {
      data = JSON.parse(e.postData.contents)
    } else if (e.parameter && e.parameter.data) {
      data = JSON.parse(e.parameter.data)
    } else {
      throw new Error('No data received')
    }
    
    const timestamp = new Date().toISOString()

    // Append team submission row
    sheet.appendRow([
      timestamp, 
      data.teamName || '', 
      data.captainMobile || '', 
      data.enrollment1 || '', 
      data.enrollment2 || '', 
      data.enrollment3 || '', 
      data.title || '', 
      data.category || '', 
      data.fileName || ''
    ])

    // If there is an image (dataURL), save it to Drive in a folder named after the sheet
    if(data.fileData){
      const matches = data.fileData.match(/^data:(image\/(png|jpeg|jpg|gif|webp));base64,(.*)$/)
      if(matches){
        const contentType = matches[1]
        const base64 = matches[3]
        const blob = Utilities.newBlob(Utilities.base64Decode(base64), contentType, data.fileName || ('upload_' + Date.now()))
        const folderName = 'PixelArt_Submissions_' + SHEET_ID
        let folders = DriveApp.getFoldersByName(folderName)
        let folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName)
        folder.createFile(blob)
      }
    }

    // Return HTML success page
    const html = `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <title>Submission Successful</title>
          <style>
            body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
            .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; max-width: 500px; }
            h1 { color: #28a745; margin: 0 0 20px 0; }
            p { color: #333; font-size: 16px; line-height: 1.6; }
            .team-name { font-weight: bold; color: #667eea; font-size: 20px; margin: 20px 0; }
            button { background: linear-gradient(135deg, #ff9800, #ffc107); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 20px; }
            button:hover { opacity: 0.9; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>✅ Submission Successful!</h1>
            <div class="team-name">${data.teamName}</div>
            <p>Your pixel art submission has been recorded successfully!</p>
            <p><strong>Artwork:</strong> ${data.title}</p>
            <p><strong>Category:</strong> ${data.category}</p>
            <p>Thank you for participating in the Mozilla Phoenix Club Pixel Art Challenge!</p>
            <button onclick="window.close()">Close Window</button>
          </div>
        </body>
      </html>
    `
    return HtmlService.createHtmlOutput(html)
    
  } catch(err){
    const errorHtml = `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <title>Submission Error</title>
          <style>
            body { font-family: Arial, sans-serif; background: #f44336; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
            .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; max-width: 500px; }
            h1 { color: #f44336; margin: 0 0 20px 0; }
            p { color: #333; }
            button { background: #f44336; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 20px; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>❌ Submission Error</h1>
            <p>${err.message}</p>
            <p>Please try again or contact the organizers.</p>
            <button onclick="window.close()">Close Window</button>
          </div>
        </body>
      </html>
    `
    return HtmlService.createHtmlOutput(errorHtml)
  }
}